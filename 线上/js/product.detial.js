$(function(){var j=window.parent.asys,k,g=util.getQueryParam("type"),b=util.getQueryParam("id");if(!g||!b){f("信息有误");if(j){j.closeModal()}}function f(i){if(!i){i="请求数据失败！请稍后再试"}if(j){j.showAlert({title:"温馨提醒",msg:i,isCancel:false})}else{alert(i)}}function m(i){if(!i){return}i.id=b;i.save_module=1;$.ajax({type:"POST",url:util.getURL("Product/edit_do"),data:i,dataType:"json",success:function(n){if(n.status){f("保存成功");if(j){j.closeModal()}}else{f(n.info)}},error:function(){f()}})}function d(){if(!b){return}$.ajax({type:"POST",url:util.getURL("Product/info"),data:{id:b,info_module:1},dataType:"json",success:function(p){if(p.status){var i=p.info;if(g=="edit"){l(1,i);l(2,i)}$("img[name='image_url']").attr("src",(i.image_url?i.image_url:""));$("input[name='image']").val(i.image?i.image:"");$("p[name='code']").html(i.code?i.code:"");$("p[name='name']").html(i.name?i.name:"");$("input[name='title']").val(i.title?i.title:"");$("p[name='title']").html(i.title?i.title:"");$("input[name='insured_area']").val(i.insured_area?i.insured_area:"");$("p[name='insured_area']").html(i.insured_area?i.insured_area:"");$("input[name='ins_limit']").val(i.ins_limit?i.ins_limit:"");$("p[name='ins_limit']").html(i.ins_limit?i.ins_limit:"");$("input[name='link']").val(i.link?i.link:"");$("p[name='link']").html(i.link?i.link:"");if(i.butt_mode==1){$("[name='butt_mode'][value='1']").click();$("p[name='butt_mode']").html("平台对接")}else{if(i.butt_mode==2){$("[name='butt_mode'][value='2']").click();$("p[name='butt_mode']").html("外链产品")}else{$("p[name='butt_mode']").html("未知")}}var v="";if(i.type==1){v="产品推广";$("[name='type'][value='1']").prop("checked",true);if(g=="show"){$("#type_show_1").show()}else{$("#type_1").show()}}else{if(i.type==2){v="产品定制";$("[name='type'][value='2']").prop("checked",true);if(g=="show"){$("#type_show_2").show()}else{$("#type_2").show()}}else{if(i.type==3){v="产品推广;产品定制";$("[name='type'][value='2']").prop("checked",true);$("[name='type'][value='1']").prop("checked",true);if(g=="show"){$("#type_show_1").show();$("#type_show_2").show()}else{$("#type_1").show();$("#type_2").show()}}else{$("[name='type'][value='2']").prop("checked",false);$("[name='type'][value='1']").prop("checked",false);$("#type_show_1").hide();$("#type_show_2").hide()}}}if(i.cls_name){$("#type_show_1 [name='cls']").show();$("#type_show_1 #cls_box").html(i.cls_name)}else{$("#type_show_1 [name='cls']").hide()}$("#type_show_1 [name='ins']").show();if(i.ins_type==1){$("#type_show_1 .ins_box").html("意外险");$("#type_1 [name=ins_type][value=1]").prop("checked",true)}else{if(i.ins_type==2){$("#type_show_1 .ins_box").html("健康险");$("#type_1 [name=ins_type][value=2]").prop("checked",true)}else{if(i.ins_type==3){$("#type_show_1 .ins_box").html("责任险");$("#type_1 [name=ins_type][value=3]").prop("checked",true)}else{if(i.ins_type==4){$("#type_show_1 .ins_box").html("财产险");$("#type_1 [name=ins_type][value=4]").prop("checked",true)}else{$("#type_1 [name=ins_type][value=1]").prop("checked",false);$("#type_1 [name=ins_type][value=2]").prop("checked",false);$("#type_1 [name=ins_type][value=3]").prop("checked",false);$("#type_1 [name=ins_type][value=4]").prop("checked",false);$("#type_show_1 [name='ins']").hide()}}}}if(i.scene_name){$("#type_show_2").show();$("#type_show_2 #scene_box").html(i.scene_name)}else{$("#type_show_2").hide()}$("p[name='type']").html(v);$("input[name='fit_people']").val(i.fit_people?i.fit_people:"");$("p[name='fit_people']").html(i.fit_people?i.fit_people:"");$("textarea[name='desc']").val(i.desc?i.desc:"");if(k){k.html(i.desc?i.desc:"")}$("div[name='desc']").html(i.desc?i.desc:"");if(i.exten){var x=[];$.each(i.exten,function(y,z){if(z.type==1){x.push("二维码")}else{if(z.type==2){x.push("推广链接")}else{if(z.type==3){x.push("APP接口")}}}$("input[name=extens][value='"+z.type+"']").prop("checked",true);$("p[name=extens]").html(x.toString())})}else{$("p[name=extens]").html("")}var q=i.app_age_start,w=i.app_age_end,o=i.insrnt_age_start,t=i.insrnt_age_end,u=i.app_age_start_type,r=i.app_age_end_type,s=i.insrnt_age_start_type,n=i.insrnt_age_end_type;$("select[name=app_age_start_type]").val(u?u:1);$("select[name=app_age_start_type]").change();$("select[name=app_age_end_type]").val(r?r:1);$("select[name=app_age_end_type]").change();$("select[name=insrnt_age_start_type]").val(s?s:1);$("select[name=insrnt_age_start_type]").change();$("select[name=insrnt_age_end_type]").val(n?n:1);$("select[name=insrnt_age_end_type]").change();$("select[name=app_age_start]").val(q);$("select[name=app_age_end]").val(w);$("select[name=insrnt_age_start]").val(o);$("select[name=insrnt_age_end]").val(t);if(q==0&&w==400){$("p[name=app_age]").html("不限")}else{if(w==400){$("p[name=app_age]").html(q+c(u)+"以上")}else{if(parseInt(w)==-1){$("p[name=app_age]").html(q+c(u)+"以下")}else{if(r==u){$("p[name=app_age]").html(q+"-"+w+c(r))}else{$("p[name=app_age]").html(q+c(u)+"-"+w+c(r))}}}}if(o==0&&t==400){$("p[name=insrnt_age]").html("不限")}else{if(t==400){$("p[name=insrnt_age]").html(o+c(s)+"以上")}else{if(parseInt(t)==-1){$("p[name=insrnt_age]").html(o+c(s)+"以下")}else{if(n==s){$("p[name=insrnt_age]").html(o+"-"+t+c(s))}else{$("p[name=insrnt_age]").html(o+c(s)+"-"+t+c(n))}}}}}else{f(p.info);if(j){j.closeModal()}}},error:function(){f();if(j){j.closeModal()}}})}function c(i){return i==1?"周岁":i==2?"月":i==3?"天":"周岁"}function l(n,i){$.ajax({type:"POST",url:util.getURL("RelatClass/lists"),data:{limit:1000,source:n},dataType:"json",success:function(o){if(o.status){var p=o.info,q,r;if(n==1){q=$("#cls_box");q.html("");r="cls_id"}else{q=$("#scene_box");q.html("");r="scene_id"}$.each(p,function(s,t){q.append('<label><input name="'+r+'" type="radio" value="'+t.id+'" >'+t.name+"</label>")});if(n==1){$("input[name=cls_id][value="+i.cls_id+"]").prop("checked",true)}else{$("input[name=scene_id][value="+i.scene_id+"]").prop("checked",true)}}else{f(o.info);if(j){j.closeModal()}}},error:function(){f();if(j){j.closeModal()}}})}if(g=="show"){$(".edit").remove();$(".button_box").remove();$(".cancle_box").text("关闭")}else{$(".show").remove()}var e='<option value="400">以上</option><option value="-1">以下</option>',a="";for(var h=0;h<=100;h++){a+='<option value="'+h+'">'+h+"</option>";e+='<option value="'+h+'">'+h+"</option>"}$(".start_age").html(a);$(".end_age").html(e);$(".age_type").change(function(){var r=this.value,q="",o=this.name.indexOf("end"),n=$(this).prev();if(o>-1){q+='<option value="400">以上</option><option value="-1">以下</option>'}if(r==3){for(var p=0;p<=180;p++){q+='<option value="'+p+'">'+p+"</option>"}}else{if(r==2){for(var p=0;p<=36;p++){q+='<option value="'+p+'">'+p+"</option>"}}else{if(r==1){for(var p=0;p<=100;p++){q+='<option value="'+p+'">'+p+"</option>"}}}}n.html(q)});$("input[name='type']").click(function(){var i=this.value;if(this.checked){$("#type_"+i).show()}else{$("#type_"+i).hide()}});$("input[name='butt_mode']").click(function(){var i=this.value;if(i==1){$(".link_box").hide()}else{$(".link_box").show()}});$("#cancle_btn").click(function(){if(j){j.closeModal()}});$("#confirm_btn").click(function(){var r=$("form").serializeArray(),p=false,s={},n=false;$.each(r,function(){if(util.trimSpace(this.value,1)!=""){if(s[this.name]){s[this.name]+=","+this.value}else{s[this.name]=this.value}}else{if(this.name=="insrnt_age_end"||this.name=="app_age_end"||this.name=="app_age_start"||this.name=="insrnt_age_start"||this.name=="link"){s[this.name]=this.value}else{p=true}}});if(s.type=="1"){s.scene_id=""}else{if(s.type=="2"){s.cls_id="";s.ins_type=""}else{if(s.type=="1,2"){s.type="3"}else{f("请选择合作类型");return}}}if(s.butt_mode==1){s.link=""}else{if(s.link==""){f("请输入外链产品链接");return}}var o,q,i,u;if(s.app_age_start_type==1){o=parseInt(s.app_age_start)*365}else{o=parseInt(s.app_age_start)}if(s.app_age_end_type==1){q=parseInt(s.app_age_end)*365}else{q=parseInt(s.app_age_end)}if(s.insrnt_age_end_type==1){i=parseInt(s.insrnt_age_end)*365}else{i=parseInt(s.insrnt_age_end)}if(s.insrnt_age_start_type==1){u=parseInt(s.insrnt_age_start)*365}else{u=parseInt(s.insrnt_age_start)}if(p){f("请完善配置信息")}else{if(s.desc.length<6){f("图文详情字数不够")}else{if((o>q&&s.app_age_end!=-1)||(s.app_age_start==0&&s.app_age_end==-1)){f("投保人年龄区间选择有误")}else{if((u>i&&s.insrnt_age_end!=-1)||(s.app_age_start==0&&s.app_age_end==-1)){f("被保险人年龄区间选择有误")}else{s.save_status=2;m(s)}}}}});$("#save_btn").click(function(){var o=$("form").serializeArray(),n=false,p={},i=false;$.each(o,function(){if(p[this.name]){p[this.name]+=","+util.trimSpace(this.value,1)}else{p[this.name]=util.trimSpace(this.value,1)}});if(p.type=="1"){p.scene_id=""}else{if(p.type=="2"){p.cls_id="";p.ins_type=""}else{if(p.type=="1,2"){p.type="3"}else{p.cls_id="";p.ins_type="";p.scene_id=""}}}p.save_status=1;m(p)});$(".updataImg").fileinput({language:"zh",uploadUrl:util.getURL("FileUpload/ueditor_upload?dir=Picture"),allowedFileExtensions:["jpg","gif","png"],uploadAsync:false,showUpload:false,showRemove:false,showPreview:false,showCaption:false,showCancel:false,browseClass:"btn btn-primary",dropZoneEnabled:false,maxFileCount:1,enctype:"multipart/form-data",validateInitialCount:false,previewFileIcon:""}).on("filebatchuploadsuccess",function(o,p,i,n){if(p.response.status){var q=p.response.info;$("input[name=image]").val(q.img);$("img[name=image_url]").attr("src",q.img_url)}else{f("上传有误")}}).on("filebatchuploaderror",function(i,n,o){$(".kv-upload-progress").addClass("hide");f("上传有误")}).on("filebatchselected",function(n,i){$(this).fileinput("upload")});KindEditor.ready(function(i){k=i.create("textarea[name=desc]",{allowImageUpload:true,uploadJson:util.getURL("FileUpload/ueditor_upload"),afterUpload:function(){this.sync()},afterBlur:function(){this.sync()}});d()})});