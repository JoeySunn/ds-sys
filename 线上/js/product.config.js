$(function(){var z=window.parent.asys,r,c=2,C,s,b,v=util.getQueryParam("type"),w=util.getQueryParam("id");if(!v||!w){u("信息有误");if(z){z.closeModal()}}$(document).keydown(function(D){if(D.keyCode==13){$("form").each(function(){D.preventDefault()})}});function u(D){if(!D){D="请求数据失败！请稍后再试"}if(z){z.showAlert({title:"温馨提醒",msg:D,isCancel:false})}else{alert(D)}}function o(){if(!w){return}$.ajax({type:"POST",url:util.getURL("Product/risk_lists"),data:{product_id:w},dataType:"json",success:function(G){if(G.status){var H=G.info;$("#risk tbody").html("");if(H){for(var E=0;E<H.length;E++){var I=H[E],F=null,D="<tr><td>"+(I.risk_type?I.risk_type:"-")+"</td><td><label class='showBox'><label class='value'>"+(I.risk_name?I.risk_name:"-")+"</label><span class='glyphicon glyphicon-edit "+(v=="show"?"hidden":"")+"'></span></label></td>";if(I.has_attr==1){$("#risk  .risk_attr").show();D+="<td class='operation'>"+(v=="edit"?'<a opName="attr_edit">编辑</a>':"<a opName='attr_show'>查看</a>")+"</td>";s=true}else{D+="<td class='operation risk_attr' "+(s?"":"hidden")+"></td>"}D+="<td class='operation'><a opName='item_config'>"+(v=="edit"?"配置":"查看")+"</a>"+(v=="edit"?(I.has_kind==1?"<div><a opName='item_copy'>复制</a></div>":"")+"<div><a hidden opName='item_paste'>粘贴</a></div>":"")+"</td><td class='operation'><a opName='premium_config'>"+(v=="edit"?"配置":"查看")+"</a>"+(v=="edit"?(I.has_kind==1?"<div><a opName='premium_copy'>复制</a></div>":"")+"<div><a hidden opName='premium_paste'>粘贴</a></div>":"")+"</td></tr>";$("#risk tbody").append(D);I.prem_calc=G.url.prem_calc;$("#risk tbody tr:last")[0].trData=I}$("#risk .operation a").hide();x("authProduct_config",$("#risk"));d()}else{$("#risk").html("<div class='noData'>暂无配置</div>");$("#attr_preview").remove();$("#item_preview").remove();$("#premium_preview").remove()}if(!s){$("#attr_preview").remove()}if(G.url.prem_calc==1){$("p[name=prem_calc]").text("按保险方案")}else{if(G.url.prem_calc==2){$("p[name=prem_calc]").text("按年龄段")}else{if(G.url.prem_calc==3){$("p[name=prem_calc]").text("按保险期间")}else{if(G.url.prem_calc==4){$("p[name=prem_calc]").text("按保险期限和年龄段")}else{$("p[name=prem_calc]").text("未知");$("#risk .operation a[opName=premium_config]").remove()}}}}}else{u(G.info);if(z){z.closeModal()}}},error:function(){u("数据请求失败！");if(z){z.closeModal()}}})}o();if(v=="show"){$(".edit").remove();$(".cancle_box").text("关闭");$(".submit_btn").remove()}else{$(".show").remove()}function t(){var F=[],E=false,D={};$("#addKind form").each(function(J){var I=$(this).serializeArray(),L={},K=0,H;$.each(I,function(){if(util.trimSpace(this.value,1)){L[this.name]=this.value}else{if(this.name!="kind_id"){E=true}}});if(E){K=1}else{if(isNaN(L.n_amt)||parseFloat(L.n_amt)<0){K=2;E=true}}if(K>0){if($("#addKind form").length>1){if(K==1){H="请完善第"+(J+1)+"个配置信息"}else{H="第"+(J+1)+"个保障金额输入有误"}}else{if(K==1){H="请完善配置信息"}else{H="保障金额输入有误"}}u(H);return false}F.push(L)});var G=$("#addKind").find("input[name=risk_type]").val();if(E){return}if(!G){u("数据有误");if(z){z.closeModal()}return}D.risk_type=G;D.product_id=w;D.kind_info=JSON.stringify(F);$.ajax({type:"POST",url:util.getURL("Product/kind_update_do"),data:D,dataType:"json",success:function(H){if(H.status){u("保存成功");o();if(C){n(C)}$("#addKind").modal("hide")}else{u(H.info)}},error:function(){u()}})}function B(){var F=[],E=false,D={};$("#attr form").each(function(I){var H=$(this).serializeArray(),J={};$.each(H,function(){if(util.trimSpace(this.value,1)){F.push({attr_id:this.name.split("_")[1],code:this.value})}else{E=true}})});var G=$("#attr").find("input[name=risk_type]").val();if(E||F.length<b){u("请完善配置信息");return}if(!G){u("数据有误");return}D.risk_type=G;D.product_id=w;D.attr_info=JSON.stringify(F);$.ajax({type:"POST",url:util.getURL("Product/risk_attr_do"),data:D,dataType:"json",success:function(H){if(H.status){u("保存成功");$("#attr").modal("hide")}else{u(H.info)}},error:function(){u()}})}function i(){if(C.prem_calc==1){var H=$("#addPremium input[name=n_prm]").val(),F=$("#addPremium input[name=risk_day]").val();if(isNaN(H)||parseFloat(H)<0){u("保费金额输入有误");return}if(isNaN(F)||parseInt(F)<0||F.indexOf(".")>-1){u("请输入正确的保险期限");return}var E={id:w,risk_type:C.risk_type,risk_price:H,risk_day:F};$.ajax({type:"POST",url:util.getURL("Product/risk_update_do"),data:E,dataType:"json",success:function(J){if(J.status){u("保存成功");o();C.risk_price=H;C.risk_day=F;if(C){l(C)}$("#addPremium").modal("hide")}else{u(J.info)}},error:function(){u()}})}else{var I=[],D=false,E={};$("#addPremium form").each(function(N){var M=$(this).serializeArray(),P={},O=0,J;$.each(M,function(){if(util.trimSpace(this.value,1)){P[this.name]=this.value}else{if(this.name!="prem_id"){D=true}}});if(D){O=1}else{if(isNaN(P.n_prm)||parseFloat(P.n_prm)<0){O=2;D=true}}if(O>0){if($("#addPremium form").length>1){if(O==1){J="请完善第"+(N+1)+"个配置信息"}else{J="第"+(N+1)+"个保费金额输入有误"}}else{if(O==1){J="请完善配置信息"}else{J="保费金额输入有误"}}u(J);return false}if(C.prem_calc==2){var L,K;if(P.start_type==1){L=parseInt(P.start_num)*365}else{L=parseInt(P.start_num)}if(P.end_type==1){K=parseInt(P.end_num)*365}else{K=parseInt(P.end_num)}if((L>K&&P.end_num!=-1)||(P.start_num==0&&P.end_num==-1)){if($("#addPremium form").length>1){J="第"+(N+1)+"个年龄区间选择有误"}else{J="年龄区间选择有误"}D=true}}else{L=parseInt(P.start_num);K=parseInt(P.end_num);if(L>K&&P.type==1){if($("#addPremium form").length>1){J="第"+(N+1)+"个时间区间选择有误"}else{J="时间区间选择有误"}D=true}}if(D){u(J);return false}if((C.prem_calc==3||C.prem_calc==4)&&P.type==2){P.start_num=0;P.end_num=365}I.push(P)});var G=$("#addPremium").find("input[name=risk_type]").val();if(D){return}if(!G){u("数据有误");return}E.risk_type=G;E.product_id=w;E.prem_info=JSON.stringify(I);$.ajax({type:"POST",url:util.getURL("Product/prem_update_do"),data:E,dataType:"json",success:function(J){if(J.status){u("保存成功");o();if(C){l(C)}$("#addPremium").modal("hide")}else{u(J.info)}},error:function(){u()}})}}function x(D,E){$.ajax({type:"POST",url:util.getURL("Permissions/right_menu"),data:{fcode:D},dataType:"json",success:function(H){if(H.status){for(var G=0;G<H.info.length;G++){var F=H.info[G].fcode.split("_");if(H.info[G].fcode=="authProduct_config_item_config"){E.find(".operation a[opName=item_config]").show()}else{if(H.info[G].fcode=="authProduct_config_premium_config"){E.find(".operation a[opName=premium_config]").show()}else{if(H.info[G].fcode=="authProduct_config_attr_edit"){E.find(".operation a[opName=attr_edit]").show()}else{if(H.info[G].fcode=="authProduct_config_attr_show"){E.find(".operation a[opName=attr_show]").show()}else{if(H.info[G].fcode=="authProduct_config_item_copy"){E.find(".operation a[opName=item_copy]").show()}else{if(H.info[G].fcode=="authProduct_config_premium_copy"){E.find(".operation a[opName=premium_copy]").show()}else{if(F[(F.length-1)]=="add"){E.find(".add_btn_box").show()}else{E.find(".operation a[opName="+F[(F.length-1)]+"]").show()}}}}}}}}}},error:function(){}})}$("input[name='type']").click(function(){var D=this.value;if(this.checked){$("#type_"+D).show()}else{$("#type_"+D).hide()}});function n(D){$.ajax({type:"POST",url:util.getURL("Product/kind_lists"),data:{product_id:w,risk_type:D.risk_type},dataType:"json",success:function(H){if(H.status){$("#itemSee").modal("show");$("#itemSee tbody").html("");var J=H.info,I=J?J.length:0,G,F;$("#itemSee .add_btn_box").hide();F="<tr><td rowspan="+I+">"+(D.risk_name?D.risk_name:"--")+"</td>";if(I==0){F+="<td>-</td><td>-</td><td>-</td><td>-</td><td class='operation "+(v=="show"?"hidden":"")+"'><a opName='edit'>编辑</a></td>"}else{G=J[0];F+="<td>"+(G.kind_cde?G.kind_cde:"--")+"</td><td>"+(G.kind_name?G.kind_name:"--")+"</td><td>"+(G.n_amt?G.n_amt:"--")+"</td><td>"+(G.kind_desc?G.kind_desc:"--")+"</td>";F+="<td class='operation "+(v=="show"?"hidden":"")+"'><a opName='edit'>编辑</a> <div><a opName='delete'>删除</a></div></td>"}F+="</tr>";$("#itemSee tbody").append(F);$("#itemSee tbody tr:last")[0].trData=G;$("#itemSee tbody tr:last")[0].riskData=D;for(var E=1;E<I;E++){G=J[E];F="<tr><td>"+(G.kind_cde?G.kind_cde:"--")+"</td><td>"+(G.kind_name?G.kind_name:"--")+"</td><td>"+(G.n_amt?G.n_amt:"--")+"</td><td>"+(G.kind_desc?G.kind_desc:"--")+"</td>";F+="<td class='operation "+(v=="show"?"hidden":"")+"'><a opName='edit'>编辑</a> <div><a opName='delete'>删除</a></div></td></tr>";$("#itemSee tbody").append(F);$("#itemSee tbody tr:last")[0].trData=G;$("#itemSee tbody tr:last")[0].riskData=D}$("#itemSee .operation a").hide();x("authProduct_config_item_config",$("#itemSee"));e()}else{u(H.info)}},error:function(){u()}})}function g(D){$.ajax({type:"POST",url:util.getURL("Product/risk_attr_info"),data:{product_id:w,risk_type:D.risk_type},dataType:"json",success:function(E){if(E.status){$("#attr").modal("show");$("#attr #editboxLabel").text(D.risk_name);$("#attr input[name=risk_type]").val(D.risk_type);$("#attr .form-horizontal").html("");b=E.info.length;$.each(E.info,function(){var G='<div class="form-group"><label class="radio col-sm-3">'+this.attr_name+"</label>";if(v=="edit"){if(this.options&&this.options[0]){G+='<div class="radio col-sm-4"><input type="radio" class="free_type" name="attr_'+this.attr_id+'" value="'+this.options[0].code+'" '+(this.options[0].is_select==1?"checked":"")+"> "+this.options[0].name+"</div>"}if(this.options&&this.options[1]){G+='<div class="radio col-sm-4"><input type="radio" class="free_type" name="attr_'+this.attr_id+'" value="'+this.options[1].code+'" '+(this.options[1].is_select==1?"checked":"")+"> "+this.options[1].name+"</div>"}G+="</div>";if(this.options){for(var F=2;F<this.options.length;F+=2){G+='<div class="form-group"><label class="radio col-sm-3"></label>';if(this.options&&this.options[F]){G+='<div class="radio col-sm-4"><input type="radio" class="free_type" name="attr_'+this.attr_id+'" value="'+this.options[F].code+'" '+(this.options[F].is_select==1?"checked":"")+"> "+this.options[F].name+"</div>"}if(this.options&&this.options[F+1]){G+='<div class="radio col-sm-4"><input type="radio" class="free_type" name="attr_'+this.attr_id+'" value="'+this.options[F+1].code+'" '+(this.options[F+1].is_select==1?"checked":"")+"> "+this.options[F+1].name+"</div>"}G+="</div>"}}}else{$("#attr #cancle_btn").text("关闭");$("#attr #submit_btn").hide();if(this.options){for(var F=0;F<this.options.length;F++){if(this.options[F].is_select==1){G+='<label class="radio col-sm-3">'+this.options[F].name+"</label>"}}}G+="</div>"}$("#attr .form-horizontal").append(G)})}else{u(E.info)}},error:function(){u()}})}function l(E){var D="",F;$("#premium tbody").html("");$("#premium thead tr").html("");if(E.prem_calc==1){D="<th>方案名称</th><th>保险期间（天）</th><th>保费（元）</th><th class='"+(v=="show"?"hidden":"")+"'>操作</th>";$("#premium thead tr").html(D);$("#premium .add_btn_box").remove();D="<tr><td>"+E.risk_name+"</td><td>"+(E.risk_day?E.risk_day:"-")+"</td><td>"+(E.risk_price?E.risk_price:"--")+"</td><td class='operation "+(v=="show"?"hidden":"")+"'><a opName='edit'>编辑</a> </td></tr>";$("#premium tbody").html(D);$("#premium").modal("show");$("#premium tbody tr:last")[0].riskData=E;$("#premium .operation a").hide();x("authProduct_config_premium_config",$("#premium"));q();F=(v=="show"?3:4);$("#premium .pop-box th").css("width",(100/F)+"%")}else{$.ajax({type:"POST",url:util.getURL("Product/prem_lists"),data:{product_id:w,risk_type:E.risk_type},dataType:"json",success:function(I){if(I.status){var K=I.info,J=K?K.length:0,H;$("#premium tbody").html("");if(E.prem_calc==2){D="<th style='width:30%'>方案名称</th><th style='width:120px'>保险期间（天）</th><th>年龄段</th><th>保费（元）</th><th class='"+(v=="show"?"hidden":"")+"'>操作</th>";F=(v=="show"?4:5);$("#premium thead tr").html(D);$("#premium .add_btn_box").hide();D="<tr><td rowspan="+J+">"+E.risk_name+"</td><td rowspan="+J+'><label class="showBox"><label class="value">'+(E.risk_day?E.risk_day:"-")+'</label><span class="glyphicon glyphicon-edit '+(v=="show"?"hidden":"")+'"></span></label></td>';if(J==0){D+="<td>-</td><td>-</td><td class='operation "+(v=="show"?"hidden":"")+"'><a opName='edit'>编辑</a></td>"}else{H=K[0];D+="<td>"+A(H.start_num,H.end_num,H.start_type,H.end_type)+"</td>";D+="<td>"+H.n_prm+"</td><td class='operation "+(v=="show"?"hidden":"")+"'><a opName='edit'>编辑</a> <div><a opName='delete'>删除</a> </div></td>"}$("#premium tbody").append(D);$("#premium tbody tr:last")[0].trData=H;$("#premium tbody tr:last")[0].riskData=E;for(var G=1;G<J;G++){H=K[G];D="<tr><td>"+A(H.start_num,H.end_num,H.start_type,H.end_type)+"</td>";D+="<td>"+H.n_prm+"</td><td class='operation "+(v=="show"?"hidden":"")+"'><a opName='edit'>编辑</a>  <div><a opName='delete'>删除</a> </div></td></tr>";$("#premium tbody").append(D);$("#premium tbody tr:last")[0].trData=H;$("#premium tbody tr:last")[0].riskData=E}}else{if(E.prem_calc==3){D="<th style='width:30%'>方案名称</th><th style='width:120px'>保险期间</th><th>保费（元）</th><th class='"+(v=="show"?"hidden":"")+"'>操作</th>";F=(v=="show"?3:4);$("#premium thead tr").html(D);$("#premium .add_btn_box").hide();D="<tr><td rowspan="+J+">"+E.risk_name+"</td>";if(J==0){D+="<td>-</td><td>-</td><td class='operation "+(v=="show"?"hidden":"")+"'><a opName='edit'>编辑</a></td>"}else{H=K[0];if(H.type==2){D+="<td>全年</td>"}else{D+="<td>"+H.start_num+"天-"+H.end_num+"天</td>"}D+="<td>"+H.n_prm+"</td><td class='operation "+(v=="show"?"hidden":"")+"'><a opName='edit'>编辑</a> <div><a opName='delete'>删除</a> </div></td>"}$("#premium tbody").append(D);$("#premium tbody tr:last")[0].trData=H;$("#premium tbody tr:last")[0].riskData=E;for(var G=1;G<J;G++){H=K[G];if(H.type==2){D="<tr><td>全年</td>"}else{D="<tr><td>"+H.start_num+"天-"+H.end_num+"天</td>"}D+="<td>"+H.n_prm+"</td><td class='operation "+(v=="show"?"hidden":"")+"'><a opName='edit'>编辑</a>  <div><a opName='delete'>删除</a> </div></td></tr>";$("#premium tbody").append(D);$("#premium tbody tr:last")[0].trData=H;$("#premium tbody tr:last")[0].riskData=E}}else{if(E.prem_calc==4){D="<th style='width:30%'>方案名称</th><th>年龄段</th><th style='width:120px'>保险期间</th><th>保费（元）</th><th class='"+(v=="show"?"hidden":"")+"'>操作</th>";F=(v=="show"?4:5);$("#premium thead tr").html(D);$("#premium .add_btn_box").hide();D="<tr><td rowspan="+J+">"+E.risk_name+"</td>";if(J==0){D+="<td>-</td><td>-</td><td>-</td><td class='operation "+(v=="show"?"hidden":"")+"'><a opName='edit'>编辑</a></td>"}else{H=K[0];D+="<td>"+(H.attr_name?H.attr_name:"")+"</td>";if(H.type==2){D+="<td>全年</td>"}else{D+="<td>"+H.start_num+"天-"+H.end_num+"天</td>"}D+="<td>"+H.n_prm+"</td><td class='operation "+(v=="show"?"hidden":"")+"'><a opName='edit'>编辑</a> <div><a opName='delete'>删除</a> </div></td>"}$("#premium tbody").append(D);$("#premium tbody tr:last")[0].trData=H;$("#premium tbody tr:last")[0].riskData=E;for(var G=1;G<J;G++){H=K[G];D="<tr><td>"+(H.attr_name?H.attr_name:"")+"</td>";if(H.type==2){D+="<td>全年</td>"}else{D+="<td>"+H.start_num+"天-"+H.end_num+"天</td>"}D+="<td>"+H.n_prm+"</td><td class='operation "+(v=="show"?"hidden":"")+"'><a opName='edit'>编辑</a>  <div><a opName='delete'>删除</a> </div></td></tr>";$("#premium tbody").append(D);$("#premium tbody tr:last")[0].trData=H;$("#premium tbody tr:last")[0].riskData=E}}}}$("#premium")[0].prem_attr=I.url.prem_attr;$("#premium").modal("show");$("#premium .operation a").hide();x("authProduct_config_premium_config",$("#premium"));q();$("#premium .pop-box th").css("width",(100/F)+"%")}else{u(I.info)}},error:function(){u()}})}}function k(D){return D==1?"周岁":D==2?"月":D==3?"天":"周岁"}function A(D,F,E,G){if(D==0&&F==400){return"不限"}else{if(F==400){return D+k(E)+"以上"}else{if(parseInt(F)==-1){return D+k(E)+"以下"}else{if(G==E){return D+"-"+F+k(G)}else{return D+k(E)+"-"+F+k(G)}}}}}function e(){$("#itemSee .operation a").click(function(){var E=$(this).attr("opName"),D=$(this).closest("tr")[0].trData,G=$(this).closest("tr")[0].riskData;if(E=="edit"){$("#addKind").modal("show");$("#addKind .add_btn_box").hide();$("#addKind  #editboxLabel").text("编辑记录");$("#addKind input[name=risk_type]").val(G.risk_type);$("#addKind input[name=kind_id]").val(D?D.id:"");$("#addKind input[name=kind_cde]").val(D?D.kind_cde:"");$("#addKind input[name=kind_name]").val(D?D.kind_name:"");$("#addKind input[name=n_amt]").val(D?D.n_amt:"");$("#addKind input[name=n_prm]").val(D?D.n_prm:"");$("#addKind textarea[name=kind_desc]").val(D?D.kind_desc:"")}else{if(E=="delete"){config={title:"温馨提醒",msg:"您确认删除该保障项目？",confirmFun:function(){$.ajax({type:"POST",url:util.getURL("Product/kind_status_do"),data:{kind_id:D.id,type:-1},dataType:"json",success:function(H){setTimeout(function(){if(H.status){u("删除成功");o();if(C){n(C)}}else{u(H.info)}},500)},error:function(){setTimeout(function(){u()},500)}})}};if(z){var F=z.showAlert(config)}else{config.confirmFun()}}}})}function q(){$("#premium .operation a").click(function(){var E=$(this).attr("opName"),D=$(this).closest("tr")[0].trData,G=$(this).closest("tr")[0].riskData;if(E=="edit"){$("#addPremium").modal("show");$("#addPremium .item_box").html("");h(G.prem_calc);$("#addPremium .add_btn_box").hide();$("#addPremium #editboxLabel").text("编辑记录");$("#addPremium").find(".item_del").hide();$("#addPremium input[name=risk_type]").val(G.risk_type);if(G.prem_calc==1){$("#addPremium input[name=n_prm]").val(G.risk_price?G.risk_price:"");$("#addPremium input[name=risk_day]").val(G.risk_day?G.risk_day:"")}else{if(D){$("#addPremium input[name=prem_id]").val(D.id?D.id:"");$("#addPremium select[name=start_num]").val(D.start_num?D.start_num:"");$("#addPremium select[name=end_num]").val(D.end_num?D.end_num:"");$("#addPremium select[name=start_type]").val(D.start_type?D.start_type:"");$("#addPremium select[name=end_type]").val(D.end_type?D.end_type:"");$("#addPremium input[name=n_prm]").val(D.n_prm?D.n_prm:"");if((G.prem_calc==3||G.prem_calc==4)&&D.type){$("#addPremium input[name=type][value="+D.type+"]").click()}if(G.prem_calc==4){$("#addPremium select[name=attr_id]").val(D.attr_id?D.attr_id:"")}}}}else{if(E=="delete"){config={title:"温馨提醒",msg:"您确认删除该保费配置吗？",confirmFun:function(){$.ajax({type:"POST",url:util.getURL("Product/prem_status_do"),data:{prem_id:D.id,type:-1},dataType:"json",success:function(H){setTimeout(function(){if(H.status){u("删除成功");o();if(C){l(C)}}else{u(H.info)}},500)},error:function(){setTimeout(function(){u()},500)}})}};if(z){var F=z.showAlert(config)}else{config.confirmFun()}}}});$("table .showBox").click(function(){if(v=="show"){return}var D=$(this).closest("tr")[0].trData,E='<div class="form-group" style="margin-bottom: 0;"><label for="risk_day" class="col-sm-2 control-label">保险期限</label><div class="col-sm-10"><input type="text" class="form-control" id="risk_day"  name="risk_day" placeholder="保险期限(天)"></div></div><label style="margin-bottom: 15px;padding-left: 67px;color: #7C7D84;">说明：保险期限为一年时，请输入365</label><input type="hidden" name="risk_type" value="'+(D.risk_type?D.risk_type:"")+'"/></div>';$("#eidtRisk form").html(E);$("#eidtRisk")[0].valueDom=[$(this).find(".value")];$("#eidtRisk")[0].editName=["risk_day"];$("#eidtRisk").modal("show")})}function d(){$("#risk .operation a").click(function(){var F=$(this).attr("opName"),E=$(this).closest("tr")[0].trData;C=E;if(F=="premium_config"){l(E)}else{if(F=="item_config"){n(E)}else{if(F=="attr_edit"){g(E)}else{if(F=="attr_show"){g(E)}else{if(F=="item_copy"||F=="premium_copy"){if(v=="show"){return}var D="item_paste";if(F=="premium_copy"){D="premium_paste"}$("#risk .operation a[opName=premium_paste]").hide();$("#risk .operation a[opName=premium_copy]").show();$("#risk .operation a[opName=item_paste]").hide();$("#risk .operation a[opName=item_copy]").show();if($(this).text()=="复制"){r=E.risk_type;$("#risk .operation a[opName="+F+"]").hide();$("#risk .operation a[opName="+D+"]").show();$(this).show();$(this).parent().parent().find("a[opName="+D+"]").hide();$("#risk .operation a[opName=premium_copy]").text("复制");$("#risk .operation a[opName=item_copy]").text("复制");$(this).text("取消复制")}else{if($(this).text()=="取消复制"){r=null;$(this).text("复制")}}}else{if(F=="item_paste"||F=="premium_paste"){if(v=="show"){return}if(!r){u("请选择需要复制的方案");return}var H="Product/kind_copy_do";if(F=="premium_paste"){H="Product/prem_copy_do"}var G={title:"温馨提醒",msg:"您确认复制到本方案中吗？",confirmFun:function(){$.ajax({type:"POST",url:util.getURL(H),data:{product_id:w,from_risk_type:r,to_risk_type:E.risk_type},dataType:"json",success:function(J){setTimeout(function(){if(J.status){u("复制成功");o()}else{u(J.info)}},500)},error:function(){setTimeout(function(){u()},500)}})}};if(z){var I=z.showAlert(G)}else{G.confirmFun()}}}}}}}});$("table .showBox").click(function(){if(v=="show"){return}var D=$(this).closest("tr")[0].trData,E='<div class="form-group"><label for="risk_name" class="col-sm-2 control-label">方案名称</label><div class="col-sm-10"><textarea type="text" class="form-control" id="risk_name"  name="risk_name" placeholder="请输入方案名称" rows=5 >'+(D.risk_name?D.risk_name:"")+'</textarea></div><input type="hidden" name="risk_type" value="'+(D.risk_type?D.risk_type:"")+'"/></div>';$("#eidtRisk form").html(E);$("#eidtRisk")[0].valueDom=[$(this).find(".value")];$("#eidtRisk")[0].editName=["risk_name"];$("#eidtRisk").modal("show")})}function f(){var H=$("#eidtRisk form").serializeArray(),D=$("#eidtRisk")[0].valueDom,G=$("#eidtRisk")[0].editName,F=false,E={};$.each(H,function(){if(util.trimSpace(this.value,1)){E[this.name]=this.value}else{u("请完善配置信息");F=true;return false}});if(!E.risk_type){u("数据有误");return}if(F){return}if(E.risk_day){if(isNaN(E.risk_day)||parseInt(E.risk_day)<0||E.risk_day.indexOf(".")>-1){u("请输入正确的保险期限");return}}E.id=w;$.ajax({type:"POST",url:util.getURL("Product/risk_update_do"),data:E,dataType:"json",success:function(I){if(I.status){$("#eidtRisk").modal("hide");u("保存成功");$.each(D,function(J){this.text(E[G[J]])})}else{u(I.info)}},error:function(){u()}})}function a(E){if(!w){return}var D;if(E=="attr_preview"){D=2}else{if(E=="item_preview"){D=3}else{if(E=="premium_preview"){D=4}else{return}}}$.ajax({type:"POST",url:util.getURL("Product/risk_lists"),data:{product_id:w,list_type:D},dataType:"json",success:function(H){if(H.status){var J=H.info,I,G=H.url.prem_calc;$("#preview .pop-box").html("");var F='<table class="table table-bordered text_center"><thead><tr class="bg_gird color_S"><th '+(G!=1&&D==4?"style='width:100px'":"")+">方案代码</th><th "+(G!=1&&D==4?"style='width:30%'":"")+">方案名称</th>";if(D==2&&J[0].has_attr==0){return}else{if(D==2&&J[0].has_attr==1){F+="<th>方案属性</th></tr></thead> <tbody>";I=3;$.each(J,function(K){F+="<tr class='"+(K%2==1?"even":"odd")+"'><td>"+(this.risk_type?this.risk_type:"--")+"</td><td>"+(this.risk_name?this.risk_name:"--")+"</td><td style='text-align: left;'>";$.each(this.attr_lists,function(){F+="<div class='attr_box'><label>"+this.attr_name+":</label><label style='margin-left:10px'>"+(this.option_name?this.option_name:"")+"</label></div>"});F+="</td></tr>"})}else{if(D==3){F+="<th>险别代码</th><th>保障项目</th><th>保险金额</th><th>项目说明</th></tr></thead> <tbody>";I=6;$.each(J,function(K){var L=(K%2==1?"even":"odd"),M=this.kind_lists?this.kind_lists.length:1;F+="<tr class='"+L+"'><td rowspan="+M+">"+(this.risk_type?this.risk_type:"--")+"</td><td rowspan="+M+">"+(this.risk_name?this.risk_name:"--")+"</td>";if(!this.kind_lists){F+="<td>--</td><td>--</td><td>--</td><td>--</td></tr>"}else{$.each(this.kind_lists,function(N){if(N!=0){F+="<tr  class='"+L+"'>"}F+="<td>"+(this.kind_cde?this.kind_cde:"--")+"</td><td>"+(this.kind_name?this.kind_name:"--")+"</td><td>"+(this.n_amt?this.n_amt:"--")+"</td><td>"+(this.kind_desc?this.kind_desc:"--")+"</td></tr>"})}})}else{if(D==4){if(G==1){F+="<th>保险期限</th><th>保费</th>";I=4}else{if(G==2){F+="<th "+(G!=1?"style='width:100px'":"")+">保险期限</th><th>年龄段</th><th>保费</th>";I=5}else{if(G==3){F+="<th>保险期间</th><th>保费</th>";I=4}else{if(G==4){F+="<th>年龄段</th><th>保险期间</th><th>保费</th>";I=5}else{return}}}}F+="</tr></thead> <tbody>";$.each(J,function(K){var L=(K%2==1?"even":"odd"),M=this.prem_lists?this.prem_lists.length:1;F+="<tr  class='"+L+"'><td rowspan="+M+">"+(this.risk_type?this.risk_type:"--")+"</td><td rowspan="+M+">"+(this.risk_name?this.risk_name:"--")+"</td>";if(G==2){F+="<td rowspan="+M+">"+(this.risk_day?this.risk_day:"--")+"</td>"}if(G==1){F+="<td>"+(this.risk_day?this.risk_day:"--")+"</td><td>"+(this.risk_price?this.risk_price:"--")+"</td></tr>"}else{if(!this.prem_lists){if(G==4){F+="<td>--</td>"}F+="<td>--</td><td>--</td></tr>"}else{$.each(this.prem_lists,function(N){if(N!=0){F+="<tr  class='"+L+"'>"}if(G==3||G==4){if(G==4){F+="<td>"+(this.attr_name?this.attr_name:"")+"</td>"}if(this.type==2){F+="<td>全年</td>"}else{if(this.start_num&&this.end_num){F+="<td>"+this.start_num+"天-"+this.end_num+"天</td>"}else{F+="<td>--</td>"}}F+="<td>"+this.n_prm+"</td></tr>"}else{if(G==2){F+="<td>"+A(this.start_num,this.end_num,this.start_type,this.end_type)+"</td><td>"+(this.n_prm?this.n_prm:"--")+"</td></tr>"}}})}}})}}}}F+="</tbody></table>";$("#preview .pop-box").html(F);$("#preview").modal("show");$("#preview .pop-box th").css("width",(100/I)+"%")}else{u(H.info);if(z){z.closeModal()}}},error:function(){u("数据请求失败！");if(z){z.closeModal()}}})}$("#cancle_btn").click(function(){if(z){z.closeModal()}});$("#addKind #submit_btn").click(function(){t()});$("#addPremium #submit_btn").click(function(){i()});$("#attr #submit_btn").click(function(){B()});$("#eidtRisk #submit_btn").click(function(){f()});$(".preview").click(function(){a(this.id)});$(".add_premium_btn").click(function(){$("#addPremium .item_box").html("");h(C.prem_calc);$("#addPremium  #editboxLabel").text("新增记录");$("#addPremium").modal("show");$("#addPremium .add_btn_box").show();$("#addPremium input[name=risk_type]").val(C.risk_type)});$(".add_premium_item_btn").click(function(){h(C.prem_calc)});function h(D){$("#addPremium .item_box").append(j(D));y();m()}function m(){$("#addPremium .num_title").each(function(D){$(this).find("label").text("区间"+(D+1));if(D==0){$(this).find(".item_del").hide()}})}function y(){$(".age_type").change(function(){var H=this.value,G="",E=this.name.indexOf("end"),D=$(this).parent().prev().find("select");if(E>-1){G+='<option value="400">以上</option><option value="-1">以下</option>'}if(H==3){for(var F=0;F<=183;F++){G+='<option value="'+F+'">'+F+"</option>"}}else{if(H==2){for(var F=0;F<=36;F++){G+='<option value="'+F+'">'+F+"</option>"}}else{if(H==1){for(var F=0;F<=100;F++){G+='<option value="'+F+'">'+F+"</option>"}}}}D.html(G)});$("#addPremium .item_del").click(function(){var D=$(this).parent();D.next().remove();D.remove();m()});$("#addPremium .time_type").click(function(){var D=this.value;if(D==1){$(this).closest(".form-group").next().show()}else{$(this).closest(".form-group").next().hide()}})}function j(H){var D='<option value="400">以上</option><option value="-1">以下</option>',J="",I="";for(var G=0;G<=100;G++){J+='<option value="'+G+'">'+G+"</option>";D+='<option value="'+G+'">'+G+"</option>"}for(var G=0;G<=183;G++){I+='<option value="'+G+'">'+G+"</option>"}var F='<div class="num_title"><label>区间</label><a class="item_del">删除</a></div><form class="form-horizontal">';if(H==2){F+='<div class="form-group"><label for="n_prm" class="col-sm-2 control-label">年龄段</label><div class="col-sm-10"><div class="col-sm-3 padding0"><select class="form-control start_age" name="start_num">'+J+'</select></div><div class="col-sm-2 padding0"><select class="form-control age_type"  name="start_type"><option value="3">天</option><option selected="selected" value="1">周岁</option></select></div><div class="col-sm-2 padding0" style="text-align:center">-</div><div class="col-sm-3 padding0"><select class="form-control end_age" name="end_num">'+D+'</select></div><div class="col-sm-2 padding0"><select class="form-control age_type" name="end_type"><option value="3">天</option><option selected="selected" value="1">周岁</option></select></div></div></div>'}else{if(H==3){F+='<div class="form-group"><label for="n_prm" class="col-sm-2 control-label">保险期间</label><div class="col-sm-10"><div class="col-sm-6 padding0"><input type="radio" class="free_type time_type" name="type" value="1" checked> 自选日期</div><div class="col-sm-6 padding0"><input type="radio" class="free_type time_type" name="type" value="2"> 全年计划</div></div></div><div class="form-group"><label for="n_prm" class="col-sm-2 control-label"></label><div class="col-sm-10"><div class="col-sm-3 padding0"><select class="form-control time_section" name="start_num">'+I+'</select></div><div class="col-sm-2 padding0"><select class="form-control" name="start_type"><option value="1">天</option></select></div><div class="col-sm-2 padding0" style="text-align:center">-</div><div class="col-sm-3 padding0"><select class="form-control time_section" name="end_num">'+I+'</select></div><div class="col-sm-2 padding0"><select class="form-control" name="end_type"><option value="1">天</option></select></div></div></div>'}else{if(H==4){F+='<div class="form-group"><label for="n_prm" class="col-sm-2 control-label">年龄段</label><div class="col-sm-10"><select class="form-control"  name="attr_id">';var E=$("#premium")[0].prem_attr;$.each(E,function(){F+='<option value="'+this.attr_id+'">'+this.attr_name+"</option>"});F+='</select></div></div><div class="form-group"><label for="n_prm" class="col-sm-2 control-label">保险期间</label><div class="col-sm-10"><div class="col-sm-6 padding0"><input type="radio" class="free_type time_type" name="type" value="1" checked> 自选日期</div><div class="col-sm-6 padding0"><input type="radio" class="free_type time_type" name="type" value="2"> 全年计划</div></div></div><div class="form-group"><label for="n_prm" class="col-sm-2 control-label"></label><div class="col-sm-10"><div class="col-sm-3 padding0"><select class="form-control time_section" name="start_num">'+I+'</select></div><div class="col-sm-2 padding0"><select class="form-control" name="start_type"><option value="1">天</option></select></div><div class="col-sm-2 padding0" style="text-align:center">-</div><div class="col-sm-3 padding0"><select class="form-control time_section" name="end_num">'+I+'</select></div><div class="col-sm-2 padding0"><select class="form-control" name="end_type"><option value="1">天</option></select></div></div></div>'}else{F+='<div class="form-group" style="margin-bottom: 0;"><label for="risk_day" class="col-sm-2 control-label">保险期限</label><div class="col-sm-10"><input type="text" class="form-control" id="risk_day"  name="risk_day" placeholder="保险期限(天)"></div></div><label style="margin-bottom: 15px;padding-left: 67px;color: #7C7D84;">说明：保险期限为一年时，请输入365</label>'}}}F+='<div class="form-group"><label for="n_prm" class="col-sm-2 control-label">保费</label><div class="col-sm-10"><input type="text" class="form-control" id="n_prm"  name="n_prm" placeholder="请输入保费(元)"></div></div><input type="hidden" name="prem_id" value=""/></form>';return F}$(".add_kind_btn").click(function(){$("#addKind").modal("show");$("#addKind  #editboxLabel").text("新增记录");$("#addKind input[name=risk_type]").val(C.risk_type);$("#addKind .add_btn_box").show();$('#addKind input[name=kind_id]').val("")});$(".add_item_btn").click(function(){var D='<div class="num_title"><label>保障项目</label><a class="item_del">删除</a></div><form class="form-horizontal"><div class="form-group"><label for="kind_cde'+c+'" class="col-sm-2 control-label">险别代码</label><div class="col-sm-10"><input type="text" class="form-control" id="kind_cde'+c+'"  name="kind_cde" placeholder="请输入险别代码"></div></div><div class="form-group"><label for="kind_name'+c+'" class="col-sm-2 control-label">保障项目</label><div class="col-sm-10"><input type="text" class="form-control" id="kind_name'+c+'"  name="kind_name" placeholder="请输入保障项目"></div></div><div class="form-group"><label for="n_amt'+c+'" class="col-sm-2 control-label">保障金额</label><div class="col-sm-10"><input type="text" class="form-control" id="n_amt'+c+'"  name="n_amt" placeholder="请输入保障金额"></div></div><div class="form-group"><label for="kind_desc'+c+'" class="col-sm-2 control-label">项目说明</label><div class="col-sm-10"><textarea type="text" class="form-control" id="kind_desc'+c+'"  name="kind_desc" placeholder="请输入项目说明" rows=5></textarea></div></div></form>';$("#addKind .item_box").append(D);p();$("#addKind .item_del").click(function(){var E=$(this).parent();E.next().remove();E.remove();p()})});$("#addKind").on("show.bs.modal",function(){$("#addKind form").each(function(D){if(D!=0){$(this).prev().remove();$(this).remove()}else{this.reset()}})});function p(){$("#addKind .num_title").each(function(D){$(this).find("label").text("保障项目"+(D+1))})}$(".updataImg").fileinput({language:"zh",browseLabel:"导入excel",uploadUrl:util.getURL("FileUpload/ueditor_upload?dir=file&action=uploadfile"),allowedFileExtensions:["jpg","gif","png"],uploadAsync:false,showUpload:false,showRemove:false,showPreview:false,showCaption:false,showCancel:false,browseClass:"btn btn-primary",dropZoneEnabled:false,maxFileCount:1,enctype:"multipart/form-data",validateInitialCount:false,previewFileIcon:""}).on("filebatchuploadsuccess",function(F,G,D,E){if(G.response.status){o()}else{u("上传有误")}}).on("filebatchuploaderror",function(D,E,F){$(".kv-upload-progress").addClass("hide");u("上传有误")}).on("filebatchselected",function(E,D){$(this).fileinput("upload")})});