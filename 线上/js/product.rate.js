$(function(){var j=window.parent.asys,h=util.getQueryParam("type"),e=util.getQueryParam("id");if(!h||!e){g("信息有误");if(j){j.closeModal()}}function g(p){if(!p){p="请求数据失败！请稍后再试"}if(j){j.showAlert({title:"温馨提醒",msg:p,isCancel:false})}else{alert(p)}}function n(p){if(!p){return}p.id=e;p.save_module=2;$.ajax({type:"POST",url:util.getURL("Product/edit_do"),data:p,dataType:"json",success:function(q){if(q.status){g("保存成功");if(j){j.closeModal()}}else{g(q.info)}},error:function(){g()}})}$(".free_val").val("");$(".free_val").attr("disabled","true");$("input[name=xsf_val]").removeAttr("disabled");function f(){if(!e){return}$.ajax({type:"POST",url:util.getURL("Product/info"),data:{id:e,info_module:2},dataType:"json",success:function(q){if(q.status){var r=q.info;if(h=="edit"){l(r);i(r)}$("input[name=tgf_amt]").val(r.tgf_amt?r.tgf_amt:"");$("p[name=tgf_amt]").html(r.tgf_amt?r.tgf_amt:"");$("input[name=price]").val(r.price?r.price:"");$("p[name=price]").html(r.price?r.price:"");$("select[name=insurer_id]").val(r.insurer_id?r.insurer_id:"");$("select[name=insurer_id]").attr("insurer_id",r.insurer_id?r.insurer_id:"");$("p[name=insurer_name]").html(r.insurer_name?r.insurer_name:"");$("select[name=ins_id]").val(r.ins_id?r.ins_id:"");$("select[name=ins_id]").attr("ins_id",r.ins_id?r.ins_id:"");$("p[name=ins_name]").html(r.ins_name?r.ins_name:"");if(r.prem_to){$("input[name=prem_to][value='"+r.prem_to+"']").click();if(r.prem_to==1){$("p[name=prem_to_text]").text("经纪公司收保费")}else{$("p[name=prem_to_text]").text("商户收保费")}}if(r.settle_date&&r.settle_date.type){$("input[name=settle_date_type][value='"+r.settle_date.type+"']").click();var p="";if(r.settle_date.type==1){p="出单时间"}else{p="保险起期"}$("p[name=settle]").html(p+"+"+(r.settle_date.val?r.settle_date.val:"0")+"天");$("input[name=settle_date_val]").val(r.settle_date.val?r.settle_date.val:"0")}else{$("p[name=settle]").html();$("input[name=settle_date_val]").val("0")}if(r.xsf&&r.xsf.prem_set_type){$("input[name=xsf_prem_set_type][value='"+r.xsf.prem_set_type+"']").click();$("p[name=prem_set]").html(r.xsf.prem_set_type==1?"仅通过经纪公司结算":"可通过多方结算（经纪公司、平台、商户）")}if(r.xsf&&r.xsf.tax_type){$("input[name=xsf_tax_type][value='"+r.xsf.tax_type+"']").click();$("input[name=xsf] .taxValue").html(r.xsf.tax_type==1?"含税":"不含税");$("input[name=jjf_xsf_tax_type][value='"+r.xsf.tax_type+"']").click();$("input[name=jjf] .taxValue").html(r.xsf.tax_type==1?"含税":"不含税")}if(r.xsf&&r.xsf.type){$("input[name=xsf_type][value='"+r.xsf.type+"']").click();$("input[name=xsf_val]").val(r.xsf.val>=0?r.xsf.val:"");$("input[name=xsf_val]").change();var p="";if(r.xsf.type==1){p="固定金额";$("p[name=xsf] .unit").html("元")}else{p="比例";$("p[name=xsf] .unit").html("%")}$("p[name=xsf] .value").html(r.xsf.val>=0?r.xsf.val:"");$("p[name=xsf] .title").html(p)}else{$("p[name=xsf] .value").html("");$("p[name=xsf] .unit").html("");$("p[name=xsf] .title").html("")}if(r.jjf&&r.jjf.type){$("input[name=jjf_type][value='"+r.jjf.type+"']").click();$("input[name=jjf_val]").val(r.jjf.val>=0?r.jjf.val:"");$("input[name=jjf_val]").change();var p="";if(r.jjf.type==1){p="固定金额";$("p[name=jjf] .unit").html("元")}else{p="比例";$("p[name=jjf] .unit").html("%")}$("p[name=jjf] .value").html(r.jjf.val>=0?r.jjf.val:"");$("p[name=jjf] .title").html(p)}else{$("p[name=jjf] .value").html("");$("p[name=jjf] .unit").html("");$("p[name=jjf] .title").html("")}if(r.fwf_ins&&r.fwf_ins.type){$("input[name=fwf_ins_type][value='"+r.fwf_ins.type+"']").click();$("input[name=fwf_ins_val]").val(r.fwf_ins.val>=0?r.fwf_ins.val:"");var p="";if(r.fwf_ins.type==1){p="固定金额";$("p[name=fwf_ins] .unit").html("元")}else{p="比例";$("p[name=fwf_ins] .unit").html("%")}$("p[name=fwf_ins] .value").html(r.fwf_ins.val>=0?r.fwf_ins.val:"");$("p[name=fwf_ins] .title").html(p)}else{$("p[name=fwf_ins] .value").html("");$("p[name=fwf_ins] .unit").html("");$("p[name=fwf_ins] .title").html("")}if(r.fwf_insurer&&r.fwf_insurer.type){$("input[name=fwf_insurer_type][value='"+r.fwf_insurer.type+"']").click();$("input[name=fwf_insurer_val]").val(r.fwf_insurer.val>=0?r.fwf_insurer.val:"");var p="";if(r.fwf_insurer.type==1){p="固定金额";$("p[name=fwf_insurer] .unit").html("元")}else{p="比例";$("p[name=fwf_insurer] .unit").html("%")}$("p[name=fwf_insurer] .value").html(r.fwf_insurer.val>=0?r.fwf_insurer.val:"");$("p[name=fwf_insurer] .title").html(p)}else{$("p[name=fwf_insurer] .value").html("");$("p[name=fwf_insurer] .unit").html("");$("p[name=fwf_insurer] .title").html("")}if(r.tgf_insurer&&r.tgf_insurer.type){$("input[name=tgf_insurer_type][value='"+r.tgf_insurer.type+"']").click();$("input[name=tgf_insurer_val]").val(r.tgf_insurer.val>=0?r.tgf_insurer.val:"");var p="";if(r.tgf_insurer.type==1){p="固定金额";$("p[name=tgf_insurer] .unit").html("元")}else{p="比例";$("p[name=tgf_insurer] .unit").html("%")}$("p[name=tgf_insurer] .value").html(r.tgf_insurer.val>=0?r.tgf_insurer.val:"");$("p[name=tgf_insurer] .title").html(p)}else{$("p[name=tgf_insurer] .value").html("");$("p[name=tgf_insurer] .unit").html("");$("p[name=tgf_insurer] .title").html("")}if(r.tgf_ins&&r.tgf_ins.type){$("input[name=tgf_ins_type][value='"+r.tgf_ins.type+"']").click();$("input[name=tgf_ins_val]").val(r.tgf_ins.val>=0?r.tgf_ins.val:"");var p="";if(r.tgf_ins.type==1){p="固定金额";$("p[name=tgf_ins] .unit").html("元")}else{p="比例";$("p[name=tgf_ins] .unit").html("%")}$("p[name=tgf_ins] .value").html(r.tgf_ins.val>=0?r.tgf_ins.val:"");$("p[name=tgf_ins] .title").html(p)}else{$("p[name=tgf_ins] .value").html("");$("p[name=tgf_ins] .unit").html("");$("p[name=tgf_ins] .title").html("")}if(r.tdf&&r.tdf.type){$("input[name=tdf_type][value='"+r.tdf.type+"']").click();$("input[name=tdf_val]").val(r.tdf.val>=0?r.tdf.val:"");a();var p="";if(r.tdf.type==1){p="固定金额";$("p[name=tdf] .unit").html("元")}else{p="比例";$("p[name=tdf] .unit").html("%")}$("p[name=tdf] .value").html(r.tdf.val>=0?r.tdf.val:"");$("p[name=tdf] .title").html(p)}else{$("p[name=tdf] .value").html("");$("p[name=tdf] .unit").html("");$("p[name=tdf] .title").html("")}if(r.tgf_plat&&r.tgf_plat.type){$("input[name=tgf_plat_type][value='"+r.tgf_plat.type+"']").click();$("input[name=tgf_plat_val]").val(r.tgf_plat.val>=0?r.tgf_plat.val:"");var p="";if(r.tgf_plat.type==1){p="固定金额";$("p[name=tgf_plat] .unit").html("元")}else{p="比例";$("p[name=tgf_plat] .unit").html("%")}$("p[name=tgf_plat] .value").html(r.tgf_plat.val>=0?r.tgf_plat.val:"");$("p[name=tgf_plat] .title").html(p)}else{$("p[name=tgf_plat] .value").html("");$("p[name=tgf_plat] .unit").html("");$("p[name=tgf_plat] .title").html("")}if(r.qdf&&r.qdf.type){$("input[name=qdf_val]").val(r.qdf.val>=0?r.qdf.val:"");$("input[name=qdf_type][value='"+r.qdf.type+"']").click();var p="";if(r.qdf.type==1){p="固定金额";$("p[name=qdf] .unit").html("元")}else{p="比例";$("p[name=qdf] .unit").html("%")}$("p[name=qdf] .value").html(r.qdf.val>=0?r.qdf.val:"");$("p[name=qdf] .title").html(p)}else{$("p[name=qdf] .value").html("");$("p[name=qdf] .unit").html("");$("p[name=qdf] .title").html("")}if(r.plat&&r.plat.type){$("input[name=plat_val]").val(r.plat.val>=0?r.plat.val:"");$("input[name=plat_type][value='"+r.plat.type+"']").click();var p="";if(r.qdf.type==1){p="固定金额";$("p[name=plat] .unit").html("元")}else{p="比例";$("p[name=plat] .unit").html("%")}$("p[name=plat] .value").html(r.plat.val>=0?r.plat.val:"");$("p[name=plat] .title").html(p)}else{$("p[name=plat] .value").html("");$("p[name=plat] .unit").html("");$("p[name=plat] .title").html("")}c()}else{g(q.info);if(j){j.closeModal()}}},error:function(){g();if(j){j.closeModal()}}})}function l(p){$.ajax({type:"POST",url:util.getURL("Insurer/lists"),data:{limit:1000},dataType:"json",success:function(q){if(q.status){var r=$("select[name=insurer_id]");r.html("");$.each(q.info,function(s,t){r.append('<option value="'+t.id+'">'+t.name+"</option>")});r.val(p.insurer_id)}else{g(q.info);if(j){j.closeModal()}}},error:function(){g();if(j){j.closeModal()}}})}function i(p){$.ajax({type:"POST",url:util.getURL("Insurance/lists"),data:{limit:1000},dataType:"json",success:function(q){if(q.status){var r=$("select[name=ins_id]");r.html("");$.each(q.info,function(s,t){r.append('<option value="'+t.id+'">'+t.name+"</option>")});r.val(p.ins_id)}else{g(q.info);if(j){j.closeModal()}}},error:function(){g();if(j){j.closeModal()}}})}f();if(h=="show"){$(".edit").remove();$(".button_box").remove();$(".cancle_box").text("关闭")}else{$(".show").remove()}$(".free_val,input[name=settle_date_val]").on("input",function(){var p=util.trimSpace(this.value);if(isNaN(p)){$(this).val("");return}if(p<0){$(this).val("");return}});$("input[name=xsf_tax_type]").click(function(){$("input[name=xsf_val]").change();c()});$("input[name=jjf_xsf_tax_type]").click(function(){$("input[name=jjf_val]").change();c()});$("input[name=settle_date_val]").change(function(){var p=util.trimSpace(this.value);if(p==""){return}if(isNaN(p)){$(this).val("");return}if(p<0){$(this).val("");return}$(this).val(parseInt(p))});$(".free_val").change(function(){var p=util.trimSpace(this.value);if(p==""){c();return}if(isNaN(p)){$(this).val("");return}if(p<0){$(this).val("");return}if(p.indexOf(".")>-1){$(this).val(parseFloat(p).toFixed(4))}c(this)});$(".free_type").click(function(){var r=this.value,q=this.name,p=$(this).closest("p").find(".unit"),s=$(this).closest("p").find(".free_tip");if(r==1){p.html("元");s.hide();$("#"+q.split("_")[0]+"_info .title").html("固定金额");$("#"+q.split("_")[0]+"_info .unit").html("元")}else{p.html("%");s.show();$("#"+q.split("_")[0]+"_info .title").html("比例");$("#"+q.split("_")[0]+"_info .unit").html("%")}c()});$("input[name=xsf_prem_set_type]").change(function(){var p=$("input[name=xsf_prem_set_type]:checked").val();if(p==1){$("#xsf_tax_box").hide();$("#fwf_insurer_box").hide();$("#tgf_insurer_box").hide();$("#xsf_tax_box .tax_box").hide();$("#jjf_box .tax_box").show()}else{$("#xsf_tax_box").show();$("#fwf_insurer_box").show();$("#tgf_insurer_box").show();$("#xsf_tax_box .tax_box").show();$("#jjf_box .tax_box").hide()}$("#free_config input[type=text]").val("");$("input[name=xsf_val]").change();$("input[name=jjf_val]").change();c()});$("input[name=xsf_val]").change(function(){var t=$("input[name=xsf_tax_type]:checked").val(),r="价税分离比例：",p=this.value,q=$(this).parent().parent().find(".free_tip");if(isNaN(p)){$(this).val("");q.text("");return}if(p<0){$(this).val("");q.text("");return}if(p==""){$(this).val("");q.text("");return}if(t==2){r+=p+"%"}else{var s=parseFloat(p)/1.06;r+=p+"/1.06≈"+(s.toFixed(4))+"%"}q.text(r)});$("input[name=jjf_val]").change(function(){var u=$("input[name=jjf_xsf_tax_type]:checked").val(),s="价税分离比例：",q=this.value,p=$("input[name=xsf_prem_set_type]:checked").val(),r=$(this).parent().parent().find(".free_tip");if(p==2){r.text("");return}if(isNaN(q)){$(this).val("");r.text("");return}if(q<0){$(this).val("");r.text("");return}if(q==""){$(this).val("");r.text("");return}if(u==2){s+=q+"%"}else{var t=parseFloat(q)/1.06;s+=q+"/1.06≈"+(t.toFixed(4))+"%"}r.text(s)});function c(p){b(p);a();o()}function b(t){var w=$("input[name=xsf_type]:checked").val(),s=$("input[name=jjf_type]:checked").val(),B=$("input[name=fwf_insurer_type]:checked").val(),C=$("input[name=tgf_insurer_type]:checked").val(),q=$("input[name=tdf_type]:checked").val(),z=$("input[name=fwf_ins_type]:checked").val(),r=$("input[name=tgf_ins_type]:checked").val(),v=$("input[name=tgf_plat_type]:checked").val(),A=$("input[name=plat_type]:checked").val(),p=parseFloat($("input[name=xsf_val]").val()),x=parseFloat($("input[name=jjf_val]").val()),u=$("input[name=xsf_prem_set_type]:checked").val(),y=$("input[name=qdf_type]:checked").val();if(u==2&&w=="2"&&s=="2"&&B=="2"&&C=="2"&&q=="2"&&z=="2"&&r=="2"&&v=="2"&&y=="2"&&A=="2"){m(t)}else{if(u==1&&s=="2"&&q=="2"&&z=="2"&&r=="2"&&v=="2"&&y=="2"&&A=="2"){m(t)}else{$(".free_val").removeAttr("disabled");$(".free_tip").hide()}}}function m(v){var y=$("input[name=xsf_type]:checked").val(),s=$("input[name=jjf_type]:checked").val(),D=$("input[name=fwf_insurer_type]:checked").val(),E=$("input[name=tgf_insurer_type]:checked").val(),q=$("input[name=tdf_type]:checked").val(),B=$("input[name=fwf_ins_type]:checked").val(),r=$("input[name=tgf_ins_type]:checked").val(),x=$("input[name=tgf_plat_type]:checked").val(),C=$("input[name=plat_type]:checked").val(),p=parseFloat($("input[name=xsf_val]").val()),z=parseFloat($("input[name=jjf_val]").val()),w=$("input[name=xsf_prem_set_type]:checked").val(),A=$("input[name=qdf_type]:checked").val();if(v&&parseFloat(v.value)>100){$(v).val("")}if(w==2&&!(p>0)){$(".free_val").val("");$(".free_val").attr("disabled","true");$("input[name=xsf_val]").removeAttr("disabled")}else{if(w==1&&!(z>0)){$(".free_val").val("");$(".free_val").attr("disabled","true");$("input[name=jjf_val]").removeAttr("disabled")}else{$(".free_val").removeAttr("disabled");$(".fwf").attr("disabled","true");$(".free_tip").show();k();d()}}if(!$("input[name=jjf_val]").val()||(parseFloat($("input[name=jjf_val]").val()))<0){$("input[name=tdf_val]").val("");$("input[name=tgf_ins_val]").val("");$("input[name=tdf_val]").attr("disabled","true");$("input[name=tgf_ins_val]").attr("disabled","true")}var t=$("input[name=fwf_ins_val]").val(),z=$("input[name=jjf_val]").val(),u=$("input[name=fwf_insurer_val]").val();if(w==1&&(!z||parseFloat(z)<0||!t||parseFloat(t)<0)){$("input[name=tgf_plat_val]").val("");$("input[name=qdf_val]").val("");$("input[name=tgf_plat_val]").attr("disabled","true");$("input[name=qdf_val]").attr("disabled","true")}else{if((w==2&&(!t||!u||parseFloat(t)<0||parseFloat(u)<0))){$("input[name=tgf_plat_val]").val("");$("input[name=qdf_val]").val("");$("input[name=tgf_plat_val]").attr("disabled","true");$("input[name=qdf_val]").attr("disabled","true")}}}function o(){var u=parseFloat($("input[name=tgf_plat_val]").val()),t=parseFloat($("input[name=qdf_val]").val()),s=parseFloat($("input[name=fwf_insurer_val]").val()),v=parseFloat($("input[name=fwf_ins_val]").val()),p=$("input[name=xsf_prem_set_type]:checked").val(),q=$("input[name=plat_val]");if(p==1&&q.attr("disabled")&&t>=0&&u>=0&&v>=0){var r=(v-t-u).toFixed(4);if(r<0){g("费用关系有误");q.val("")}else{q.val(r)}}else{if(p==2&&q.attr("disabled")&&t>=0&&u>=0&&s>=0&&v>=0){var r=(s+v-t-u).toFixed(4);if(r<0){g("费用关系有误");q.val("")}else{q.val(r)}}else{if(q.attr("disabled")){q.val("")}}}}function a(){var v="系统换算结果：通道费占保费比例≈",q=parseFloat($("input[name=jjf_val]").val()),t=$("input[name=fwf_insurer_val]"),w=$("input[name=jjf_xsf_tax_type]:checked").val(),p=$("input[name=xsf_prem_set_type]:checked").val(),s=parseFloat($("input[name=tdf_val]").val()),u=$("input[name=tdf_val]").parent().parent().find(".free_tip");if(p==2&&q>=0&&s>=0){var r=(q*s/100).toFixed(4);if(r<0){g("费用关系有误");u.text("")}else{u.text(v+r+"%")}}else{if(p==1&&q>=0&&s>=0){var r;if(w==1){r=(parseFloat((q/1.06).toFixed(4))*s/100).toFixed(4)}else{r=(q*s/100).toFixed(4)}if(r<0){g("费用关系有误");u.text("")}else{u.text(v+r+"%")}}else{u.text("")}}}function d(){var s=parseFloat($("input[name=tdf_val]").val()),q=parseFloat($("input[name=jjf_val]").val()),w=parseFloat($("input[name=tgf_ins_val]").val()),v=$("input[name=jjf_xsf_tax_type]:checked").val(),p=$("input[name=xsf_prem_set_type]:checked").val(),t=$("input[name=fwf_ins_val]"),u;if(t.attr("disabled")&&s>=0&&q>=0&&w>=0){if(p==1){var r;if(v==1){r=(parseFloat((q/1.06).toFixed(4))-((parseFloat((q/1.06).toFixed(4))*s/100)+w)).toFixed(4)}else{r=(q-(q*s/100)-w).toFixed(4)}if(r<0){g("费用关系有误");t.val("")}else{t.val(r)}}else{var r=(q-(q*s/100)-w).toFixed(4);if(r<0){g("费用关系有误");t.val("")}else{t.val(r)}}}else{if(t.attr("disabled")){t.val("")}}}function k(){var p=parseFloat($("input[name=xsf_val]").val()),q=parseFloat($("input[name=jjf_val]").val()),u=$("input[name=xsf_tax_type]:checked").val(),t=parseFloat($("input[name=tgf_insurer_val]").val()),r=$("input[name=fwf_insurer_val]"),s;if(r.attr("disabled")&&p>=0&&q>=0&&t>=0){if(u==2){s=p-q-t}else{s=parseFloat((p/1.06).toFixed(4))-q-t}if(s<0){g("费用关系有误");r.val("")}else{r.val(s.toFixed(4))}}else{if(r.attr("disabled")){r.val("")}}}$("input[name=xsf_prem_set_type]").change();$("#cancle_btn").click(function(){if(j){j.closeModal()}});$("#confirm_btn").click(function(){var q=$("form").serializeArray(),p=false,r={},s=false;$.each(q,function(){if(util.trimSpace(this.value,2)){if(this.name.indexOf("val")>-1&&(isNaN(this.value)||parseFloat(this.value)<0)){s=true}else{if(r[this.name]){r[this.name]+=","+this.value}else{r[this.name]=this.value}}}else{p=true}});r.fwf_insurer_val=$("input[name=fwf_insurer_val]").val();r.fwf_ins_val=$("input[name=fwf_ins_val]").val();r.plat_val=$("input[name=plat_val]").val();if(s){g("请输入正数");return}if(r.xsf_prem_set_type==1){r.xsf_tax_type=r.jjf_xsf_tax_type;delete r.jjf_xsf_tax_type;if(r.jjf_val&&r.tdf_val&&r.fwf_ins_val&&r.tgf_ins_val&&r.tgf_plat_val&&r.qdf_val&&r.plat_val){r.save_status=2;n(r)}else{g("请完善配置信息")}}else{if(s){g("请输入正数")}else{if(p){g("请完善配置信息")}else{r.save_status=2;n(r)}}}});$("#save_btn").click(function(){var r=$("form").serializeArray(),q=false,s={},p=false;$.each(r,function(){if(s[this.name]){s[this.name]+=","+util.trimSpace(this.value,2)}else{s[this.name]=util.trimSpace(this.value,2)}});s.fwf_insurer_val=$("input[name=fwf_insurer_val]").val();s.fwf_ins_val=$("input[name=fwf_ins_val]").val();s.plat_val=$("input[name=plat_val]").val();if(s.xsf_prem_set_type==1){s.xsf_tax_type=s.jjf_xsf_tax_type;delete s.jjf_xsf_tax_type}if(s.type){if(s.type=="1,2"){s.type="3"}}s.save_status=1;n(s)})});